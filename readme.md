# Синхронизация Git-репозитория через Google Drive

Для тех, у кого нет по какой либо причине доступа к github, но есть доступ к Google Drive.
Это расширение для VS Code превращает ваш Google Drive в простое и надежное хранилище для Git-репозиториев. Оно использует Google Drive как "транспорт" для обмена данными с помощью файлов-бандлов (`.bundle`), позволяя организовать децентрализованную работу, удобную для оффлайн-доступа и простого резервного копирования.

## Основная идея

Вместо того чтобы хранить на диске один большой файл с полной копией репозитория, расширение работает с **разностными бандлами**.

-   **Push (Отправка):** Когда вы отправляете изменения, расширение создает небольшой бандл, содержащий только новые коммиты, сделанные с момента последней синхронизации.
-   **Pull (Получение):** Когда вы получаете изменения, расширение скачивает только те бандлы (коммиты), которых у вас еще нет.

Этот подход делает синхронизацию быстрой, эффективной и устойчивой к ошибкам.

## Основные функции

-   **Быстрая синхронизация:** Обмен только небольшими, инкрементальными изменениями.
-   **Клонирование:** Возможность развернуть репозиторий из Google Drive в пустой папке.
-   **Автоматическая синхронизация:** Git-хук `post-commit` может автоматически отправлять ваши коммиты сразу после их создания.
-   **Защита истории:** Расширение не позволит отправить изменения, если ваша локальная история была переписана (`git rebase`, `git commit --amend`), чтобы избежать повреждения общей истории на Google Drive.
-   **Ручное управление:** Команды для ручного управления точками синхронизации на случай, если что-то пошло не так.

## Где взять client_secret.json?

Файл `client_secret.json` — это ключ, который дает расширению доступ к вашему Google Drive от вашего имени. Вы должны создать его самостоятельно в Google Cloud Console. Это бесплатно и займет около 5-10 минут.

**Важно:** Храните этот файл в надежном месте и никому его не показывайте.

### Пошаговая инструкция

1.  **Перейдите в Google Cloud Console:**
    *   Откройте [console.cloud.google.com](https://console.cloud.google.com) и войдите под своим Google-аккаунтом.

2.  **Создайте новый проект:**
    *   В верхней панели нажмите на выпадающий список проектов (рядом с логотипом Google Cloud) и выберите **"New Project"**.
    *   Дайте проекту любое имя (например, "VSCode Git Sync") и нажмите **"Create"**.

3.  **Включите Google Drive API:**
    *   В меню навигации (☰) выберите **"APIs & Services" -> "Enabled APIs & services"**.
    *   Нажмите **"+ ENABLE APIS AND SERVICES"**.
    *   В поиске введите "Google Drive API" и выберите его из списка.
    *   Нажмите кнопку **"Enable"**.

4.  **Настройте экран согласия OAuth:**
    *   В меню навигации выберите **"APIs & Services" -> "OAuth consent screen"**.
    *   Выберите тип пользователя **"External"** (Внешний) и нажмите **"Create"**.
    *   **Шаг 1: App information**
        *   **App name:** Введите имя приложения, например "VSCode Git Sync".
        *   **User support email:** Выберите ваш email.
        *   **Developer contact information:** Укажите ваш email.
        *   Нажмите **"SAVE AND CONTINUE"**.
    *   **Шаг 2: Scopes:** Ничего не меняйте, просто нажмите **"SAVE AND CONTINUE"**.
    *   **Шаг 3: Test users:**
        *   Нажмите **"+ ADD USERS"**.
        *   Введите свой собственный Google-адрес. Это позволит вам использовать приложение, пока оно находится в "тестовом" режиме.
        *   Нажмите **"ADD"**, а затем **"SAVE AND CONTINUE"**.
    *   **Шаг 4: Summary:** Просмотрите информацию и нажмите **"BACK TO DASHBOARD"**.

5.  **Создайте учетные данные:**
    *   В меню навигации выберите **"APIs & Services" -> "Credentials"**.
    *   Нажмите **"+ CREATE CREDENTIALS"** и выберите **"OAuth client ID"**.
    *   В выпадающем списке **"Application type"** выберите **"Desktop app"**.
    *   Дайте ему имя (например, "VSCode Extension Client").
    *   Нажмите **"Create"**.

6.  **Скачайте JSON-файл:**
    *   Появится окно с вашим Client ID и Client Secret.
    *   Справа нажмите кнопку **"DOWNLOAD JSON"**.
    *   Сохраните этот файл. **Это и есть ваш `client_secret.json`**.

Теперь вы можете использовать этот скачанный файл в команде "Установить учетные данные Google".

## Насколько это безопасно?

**Короткий ответ: да, безопасно.**

Расширение спроектировано по принципу **минимальных привилегий**. При аутентификации оно запрашивает доступ только к `drive.file`, что дает ему право:

-   Создавать новые файлы и папки.
-   Читать и изменять **только те файлы и папки, которые оно само создало**.

Расширение **НЕ МОЖЕТ**:

-   Читать, изменять или удалять другие ваши файлы на Google Drive (документы, фото и т.д.).
-   Просматривать список всех файлов и папок на вашем диске.

Ваши личные токены доступа хранятся в защищенном хранилище VS Code и никогда не покидают ваш компьютер. Ваша ответственность — безопасно передать `client_secret.json` команде и предоставить доступ к папке проекта только доверенным лицам.

## Рабочий процесс

### 1. Первоначальная настройка (для всех)

1.  **Установить учетные данные:**
    -   Выполните команду `> ChangeGitToGoogleDrive: Установить учетные данные Google`.
    -   Выберите ваш файл `client_secret.json`, полученный из Google Cloud Console.
2.  **Аутентификация:**
    -   Выполните команду `> ChangeGitToGoogleDrive: Аутентификация с Google`.
    -   Браузер откроет страницу входа в Google. Войдите и разрешите доступ.

### 2. Создание нового репозитория

1.  В папке вашего проекта инициализируйте Git (`git init`).
2.  Сделайте первый коммит (`git add .` и `git commit -m "Initial commit"`).
3.  **Установите Git-хуки:**
    -   Выполните команду `> ChangeGitToGoogleDrive: Install Git Hooks`.
    -   Это позволит автоматически отправлять коммиты на Google Drive.
4.  **Первая синхронизация:**
    -   Выполните команду `> ChangeGitToGoogleDrive: Sync with Google Drive`.
    -   Ваш первый коммит будет упакован в бандл и загружен на Google Drive. Все последующие коммиты будут отправляться автоматически.

### 3. Клонирование существующего репозитория

1.  Откройте **пустую** папку в VS Code.
2.  Выполните команду `> ChangeGitToGoogleDrive: Клонировать из Google Drive`.
3.  Выберите проект и бандл для клонирования (рекомендуется самый новый).
4.  Расширение скачает репозиторий и развернет его.
5.  Во всплывающем окне **согласитесь** на установку Git-хуков для автоматической синхронизации.
6.  Окно VS Code будет перезагружено, и проект готов к работе.

### 4. Ежедневная работа

-   **Перед началом работы:** Чтобы получить последние изменения от других, выполните `> ChangeGitToGoogleDrive: Sync with Google Drive`.
-   **Работайте как обычно:** Пишите код и делайте коммиты (`git commit`). Сразу после коммита хук автоматически отправит ваши изменения в облако.

## Организация совместной работы

Ключ к совместной работе — **общий `client_secret.json`** и **общая папка на Google Drive**.

-   **`client_secret.json`** — это паспорт вашего *приложения*, а не ваш личный. Вся команда должна использовать **один и тот же** файл, чтобы Google понимал, что все запросы идут от одного и того же приложения.
-   **Аутентификация** — это личное разрешение каждого пользователя. Когда коллега проходит аутентификацию, он разрешает приложению доступ к своему Google Drive от своего имени.

### Порядок действий для команды

1.  **Администратор (первый участник):**
    *   Создает `client_secret.json` (согласно инструкции выше).
    *   Настраивает расширение и делает первую выгрузку (`Sync`).
    *   На его Google Drive создается папка `.gdrive-git/<имя_проекта>`.
    *   **Важнейший шаг:** Заходит на Google Drive, находит эту папку и **предоставляет доступ** к ней своим коллегам с правами **"Редактор" (Editor)**.
    *   Передает файл `client_secret.json` своей команде по защищенному каналу.

2.  **Остальные участники:**
    *   Получают `client_secret.json` от администратора.
    *   Устанавливают его в своем VS Code (`> ChangeGitToGoogleDrive: Установить учетные данные Google`).
    *   Проходят аутентификацию (`> ChangeGitToGoogleDrive: Аутентификация с Google`), входя в **свою собственную** учетную запись Google.
    *   Теперь они могут клонировать репозиторий или синхронизировать изменения, так как у них есть доступ к общей папке.

## Работа с ветками

### Текущее ограничение

На данный момент синхронизация (команда `Sync`) работает только для **текущей активной ветки**. Если ваш коллега создал новую ветку и отправил ее на Google Drive, вы не получите ее автоматически, пока находитесь в своей ветке.

### Как получить новую ветку с Google Drive

1.  Узнайте у коллеги точное название новой ветки (например, `feature/new-login`).
2.  Создайте у себя локальную ветку **с точно таким же именем**.
    -   **Важно:** Чтобы избежать проблем, лучше всего создавать ветку от общего, уже синхронизированного коммита (например, от последнего коммита в `main` или от самого первого коммита в проекте).
    -   Пример: `git checkout -b feature/new-login main`
3.  Переключившись на эту новую ветку, выполните команду `> ChangeGitToGoogleDrive: Sync with Google Drive`.
4.  Расширение найдет на Google Drive бандлы для этой ветки, скачает их и применит к вашей локальной версии.

---
Для просмотра схем из папки `docs` можно воспользоваться расширением [DrakonWidget](https://github.com/adva-cg/drakonwidget-for-vscode). На текущий момент, схемы устарели.